#!/bin/bash

sybase_startup_remote() {
    local HOSTNAME="$1"
    local SID="$2"
    local SYBASE_USER="$3"
    local SERVICE_SCRIPT="$4"
    local EXIT_CODE

    echo "--- Starting Remote Sybase Services ---"
    echo "Host: $HOSTNAME | SID: $SID | User: $SYBASE_USER"
    echo "------------------------------------------------"

    # 1. Constructing commands for remote execution
    # Corrected: Escaped parentheses in echo statements.
    local STARTUP_COMMANDS=$(cat <<EOF
# Execute external service script first
echo "Running service script: $SERVICE_SCRIPT...";
$SERVICE_SCRIPT -s $SID -t db -a istart;

# Source Sybase environment
source /sybase/$SID/SYBASE.csh;
echo "Environment sourced: /sybase/$SID/SYBASE.csh";

# Start primary server
/sybase/BOS/ASE-16_0/bin/startserver -f /sybase/BOS/ASE-16_0/install/RUN_BOS;
echo "Primary server \(RUN_BOS\) command executed."; # <-- ESCAPED PARENTHESES

# Start backup server
/sybase/BOS/ASE-16_0/bin/startserver -f /sybase/BOS/ASE-16_0/install/RUN_BOS_BS;
echo "Backup server \(RUN_BOS_BS\) command executed."; # <-- ESCAPED PARENTHESES

# Check SQL connection
echo "Checking SQL connection...";
isql -Usapsa -S$SID -w160 -X <<EOSQL
select @@servername
go
quit
EOSQL
# Check the isql connection exit code
if [ \$? -ne 0 ]; then
    echo "ERROR: SQL connection check failed!"
    exit 1
fi
echo "SQL connection check finished."
EOF
    )
    
    # 2. Constructing the full SSH string (FIXED: Simplified su - execution)
    # Define a temporary variable for clean substitution
    local SYBASE_COMMANDS="$STARTUP_COMMANDS"

    # Use single quotes around EOF_SCRIPT to preserve the dollar signs until substitution
    local FULL_REMOTE_SCRIPT=$(cat << 'EOF_SCRIPT'
# The remote execution is started as root via 'sudo bash -s'
echo "â˜‘ï¸ ROOT Connection: Successful"

# Use 'su -' fed by a Heredoc for clean user switch and command execution
su - $SYBASE_USER << 'EOF_SU'
echo "â˜‘ï¸ User Switch: Successful (su - $SYBASE_USER)"

# Execute the commands defined in $STARTUP_COMMANDS
$SYBASE_COMMANDS

EOF_SU

# Pass the exit code of the 'su' command back to the SSH session
exit $?
EOF_SCRIPT
    )

    # Substitute the variables into the FULL_REMOTE_SCRIPT AFTER definition
    FULL_REMOTE_SCRIPT="${FULL_REMOTE_SCRIPT//\$SYBASE_USER/$SYBASE_USER}"
    FULL_REMOTE_SCRIPT="${FULL_REMOTE_SCRIPT//\$SYBASE_COMMANDS/$SYBASE_COMMANDS}"


    # 3. Executing SSH and checking connection status
    echo -e "\nðŸ’¬ Attempting connection to $HOSTNAME and starting services:"
    
    # Using '<<< "$FULL_REMOTE_SCRIPT"' is cleaner than piping with 'echo'
    # The 'sudo' is implicitly executed if needed, but we rely on SSH keys for login
    # If the user is logging in as root, remove 'sudo' from the command.
    ssh "$HOSTNAME" "sudo bash -s" <<< "$FULL_REMOTE_SCRIPT" 
    EXIT_CODE=$?

    # 4. Analyzing SSH exit code
    if [ $EXIT_CODE -eq 0 ]; then
        echo "------------------------------------------------"
        echo "âœ… SYSTEM STARTUP $SID: Execution completed (Exit Code 0). Check remote logs for service status!"
    elif [ $EXIT_CODE -eq 1 ]; then
        echo "------------------------------------------------"
        echo "âš ï¸ SYSTEM STARTUP $SID: Completed with potential errors (Exit Code 1). Check remote logs!"
    else
        echo "------------------------------------------------"
        echo "âŒ SSH CONNECTION: FAILED! (Exit Code $EXIT_CODE)"
        echo "   Could not connect to $HOSTNAME. Check hostname or SSH keys."
        return 1
    fi
}
# --- Example usage (uncomment for testing) ---
# sybase_startup_remote "user@hostname" "BOS" "sybbos" "/path/to/ff_service.sh"
