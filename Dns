#!/bin/bash

sybase_startup_remote() {
    local HOSTNAME="$1"
    local SID="$2"
    local SYBASE_USER="$3"
    local SERVICE_SCRIPT="$4"
    local EXIT_CODE

    echo "--- Starting Remote Sybase Services ---"
    echo "Host: $HOSTNAME | SID: $SID | User: $SYBASE_USER"
    echo "------------------------------------------------"

    # 1. Constructing commands for remote execution
    # This block includes the service script execution, source, startserver commands, and SQL check.
    local STARTUP_COMMANDS=$(cat <<EOF
# Execute external service script first
echo "Running service script: $SERVICE_SCRIPT...";
$SERVICE_SCRIPT -s $SID -t db -a istart;

# Source Sybase environment
source /sybase/$SID/SYBASE.csh;
echo "Environment sourced: /sybase/$SID/SYBASE.csh";

# Start primary server
/sybase/BOS/ASE-16_0/bin/startserver -f /sybase/BOS/ASE-16_0/install/RUN_BOS;
echo "Primary server (RUN_BOS) command executed.";

# Start backup server
/sybase/BOS/ASE-16_0/bin/startserver -f /sybase/BOS/ASE-16_0/install/RUN_BOS_BS;
echo "Backup server (RUN_BOS_BS) command executed.";

# Check SQL connection
echo "Checking SQL connection...";
isql -Usapsa -S$SID -w160 -X <<EOSQL
select @@servername
go
quit
EOSQL
echo "SQL connection check finished."
EOF
    )

    # 2. Constructing the full SSH string (sudo -> su - <user> -> commands)
    local FULL_REMOTE_SCRIPT=$(cat <<EOF_SCRIPT
# Internal script for remote execution
sudo -i <<EOF_SUDO
    echo "â˜‘ï¸ ROOT Connection: Successful (sudo -i)"
    su - $SYBASE_USER -c "
        echo \"â˜‘ï¸ User Switch: Successful (su - $SYBASE_USER)\"
        
        # Execute startup commands
        bash -c \"
            $STARTUP_COMMANDS
        \"
    "
EOF_SUDO
EOF_SCRIPT
    )

    # 3. Executing SSH and checking connection status
    echo -e "ðŸ’¬ Attempting connection to $HOSTNAME and starting services:\n"
    
    echo "$FULL_REMOTE_SCRIPT" | ssh "$HOSTNAME" 'bash -s'
    EXIT_CODE=$?

    # 4. Analyzing SSH exit code
    if [ $EXIT_CODE -eq 0 ]; then
        echo "------------------------------------------------"
        echo "âœ… SYSTEM STARTUP $SID: Execution completed (Exit Code 0). Check remote logs for service status!"
    elif [ $EXIT_CODE -eq 1 ]; then
        echo "------------------------------------------------"
        echo "âš ï¸ SYSTEM STARTUP $SID: Completed with potential errors (Exit Code 1). Check remote logs!"
    else
        echo "------------------------------------------------"
        echo "âŒ SSH CONNECTION: FAILED! (Exit Code $EXIT_CODE)"
        echo "   Could not connect to $HOSTNAME. Check hostname or SSH keys."
        return 1
    fi
}
# --- Example usage (uncomment for testing) ---
# sybase_startup_remote "user@hostname" "BOS" "sybbos" "/path/to/ff_service.sh"
