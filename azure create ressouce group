How to Execute a Script When a VM Starts

Method 1: Use a Systemd Service in sys-firewall

You can create a systemd service to monitor new network interfaces (which are created when a VM starts) and apply the appropriate rules.

1. Create the Script: Save the script as /rw/config/qubes-firewall-update.sh in sys-firewall:

#!/bin/bash

# Update firewall rules for active VMs
for vm in $(qvm-ls --raw-data --fields NAME); do
    vif=$(ip link | grep "vif.*${vm}" | awk -F: '{print $2}' | tr -d ' ')
    if [[ -n $vif ]]; then
        case "$vm" in
            browser-vm)
                sudo nft add rule inet filter forward iifname "$vif" tcp dport {80, 443} accept
                sudo nft add rule inet filter forward oifname "$vif" tcp sport {80, 443} accept
                ;;
            mail-vm)
                sudo nft add rule inet filter forward iifname "$vif" tcp dport {25, 110, 143, 465, 587, 993} accept
                sudo nft add rule inet filter forward oifname "$vif" tcp sport {25, 110, 143, 465, 587, 993} accept
                ;;
            *)
                echo "No specific rules for $vm"
                ;;
        esac
    fi
done


2. Make the Script Executable:

chmod +x /rw/config/qubes-firewall-update.sh


3. Create a Systemd Service: Create a file /etc/systemd/system/update-firewall.service:

[Unit]
Description=Update Firewall Rules for VMs
After=network.target

[Service]
ExecStart=/rw/config/qubes-firewall-update.sh
Type=oneshot

[Install]
WantedBy=multi-user.target


4. Create a Systemd Path Unit: Use a path unit to monitor changes to network interfaces. Create /etc/systemd/system/update-firewall.path:

[Unit]
Description=Monitor VM Network Interfaces for Firewall Updates

[Path]
PathChanged=/sys/class/net

[Install]
WantedBy=multi-user.target


5. Enable the Service and Path Unit:

sudo systemctl enable update-firewall.path
sudo systemctl start update-firewall.path


