# Создание таблицы inet filter
nft add table inet filter

# Создание цепочек в таблице filter
nft add chain inet filter input { type filter hook input priority filter; policy accept; }
nft add chain inet filter forward { type filter hook forward priority filter; policy accept; }
nft add chain inet filter output { type filter hook output priority filter; policy accept; }

# Создание таблицы ip qubes
nft add table ip qubes

# Создание набора downstream
nft add set ip qubes downstream { type ipv4_addr; }

# Создание набора allowed
nft add set ip qubes allowed { type ifname . ipv4_addr; }

# Создание цепочки prerouting
nft add chain ip qubes prerouting { type filter hook prerouting priority raw; policy accept; }
nft add rule ip qubes prerouting iifgroup 2 goto antispoof
nft add rule ip qubes prerouting ip saddr @downstream counter packets 0 bytes drop

# Создание цепочки antispoof
nft add chain ip qubes antispoof { }
nft add rule ip qubes antispoof iifname . ip saddr @allowed accept
nft add rule ip qubes antispoof counter packets 0 bytes drop

# Создание цепочки postrouting
nft add chain ip qubes postrouting { type nat hook postrouting priority srcnat; policy accept; }
nft add rule ip qubes postrouting oifgroup 2 accept
nft add rule ip qubes postrouting oif "lo" accept
nft add rule ip qubes postrouting masquerade

# Настройка цепочки input
nft add chain inet filter input { type filter hook input priority filter; policy drop; }
nft add rule inet filter input ct state invalid counter packets 0 bytes drop
nft add rule inet filter input iifgroup 2 udp dport 68 counter packets 0 bytes drop
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input iif "lo" accept
nft add rule inet filter input iifgroup 2 counter packets 0 bytes reject with icmp host-prohibited

# Настройка цепочки forward
nft add chain inet filter forward { type filter hook forward priority filter; policy accept; }
nft add rule inet filter forward ct state invalid counter packets 0 bytes drop
