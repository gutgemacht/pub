#!/bin/bash

# Flush existing rules and reset
nft flush ruleset

# Create the filter table and chains
nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; policy drop; }
nft add chain inet filter output { type filter hook output priority 0; policy drop; }

# Allow incoming DNS-over-TLS (DoT) requests on port 853
nft add rule inet filter input ip protocol tcp dport 853 ct state new,related,established accept

# Allow outgoing DNS-over-TLS responses from port 853
nft add rule inet filter output ip protocol tcp sport 853 ct state established,related accept

# Allow outgoing DNS-over-TLS queries to upstream resolvers on port 853
nft add rule inet filter output ip protocol tcp dport 853 ct state new,related,established accept

# Allow general connection tracking for established/related connections
nft add rule inet filter input ct state established,related accept
nft add rule inet filter output ct state established,related accept

# Drop everything else
nft add rule inet filter input drop
nft add rule inet filter output drop

# Save rules to /etc/nftables.conf
nft list ruleset > /etc/nftables.conf

# Enable and restart nftables service
systemctl enable nftables
systemctl restart nftables

echo "nftables configuration for DNS-over-TLS on port 853 applied successfully."
